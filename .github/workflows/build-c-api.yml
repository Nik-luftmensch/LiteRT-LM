name: Build C API Shared Library

on:
  workflow_dispatch:

jobs:
  build-android-arm64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Install Bazelisk
      run: |
        sudo curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.19.0/bazelisk-linux-amd64 -o /usr/local/bin/bazel
        sudo chmod +x /usr/local/bin/bazel
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      id: setup-ndk
      with:
        ndk-version: r28b
        
    - name: Set NDK environment
      run: |
        echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
        
    - name: Build full LiteRT-LM library
      run: |
        bazel build --config=android_arm64 //kotlin/java/com/google/ai/edge/litertlm/jni:litertlm_jni
        
    - name: Package artifacts
      run: |
        mkdir -p artifacts/include
        
        # Copy from exact known path
        cp bazel-bin/kotlin/java/com/google/ai/edge/litertlm/jni/liblitertlm_jni.so artifacts/
        
        # Copy header files
        cp c/engine.h artifacts/include/
        cp c/litert_lm_logging.h artifacts/include/ || true
        
        # List what we got
        echo "=== Artifacts ==="
        ls -la artifacts/
        echo "=== Headers ==="
        ls -la artifacts/include/
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: litert-lm-android-arm64-full
        path: artifacts/
